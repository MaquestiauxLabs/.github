name: Update Project Stats
on:
  schedule:
    - cron: '0 0 * * 0' # Runs every Sunday at midnight
  workflow_dispatch:   # Allows manual trigger for testing

permissions:
  contents: write

jobs:
  stats:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Fetch and Process Org Stats
        env:
          GH_TOKEN: ${{ secrets.METRICS_TOKEN }}
        run: |
          # 1. Get Projects (excluding the .github repo project)
          PROJECTS=$(gh api graphql -f query='query($org: String!){organization(login: $org){projectsV2(first: 20){nodes{id number title}}}}' -f org="MaquestiauxLabs" --jq '.data.organization.projectsV2.nodes[] | select(.title != ".github") | "\(.number)|\(.title)"')

          T_TODO=0; T_ONGOING=0; T_DONE=0

          while IFS="|" read -r NUM TITLE; do
            QUERY='query($org: String!, $num: Int!){organization(login: $org){projectV2(number: $num){items(first: 100){nodes{status:fieldValueByName(name:"Status"){... on ProjectV2ItemFieldSingleSelectValue{name}}}}}}}'
            RESULT=$(gh api graphql -f query="$QUERY" -f org="MaquestiauxLabs" -F num=$NUM)
            
            # Map labels: Planned/Todo, In Progress/Ongoing, Complete/Done
            P_TODO=$(echo $RESULT | jq '[.data.organization.projectV2.items.nodes[] | select(.status.name == "Todo" or .status.name == "Planned")] | length')
            P_ONGOING=$(echo $RESULT | jq '[.data.organization.projectV2.items.nodes[] | select(.status.name == "In Progress" or .status.name == "Ongoing")] | length')
            P_DONE=$(echo $RESULT | jq '[.data.organization.projectV2.items.nodes[] | select(.status.name == "Done" or .status.name == "Complete")] | length')

            T_TODO=$((T_TODO + P_TODO))
            T_ONGOING=$((T_ONGOING + P_ONGOING))
            T_DONE=$((T_DONE + P_DONE))

            echo "{\"project\": \"$TITLE\", \"todo\": $P_TODO, \"ongoing\": $P_ONGOING, \"done\": $P_DONE}" > "project-$NUM-stats.json"
          done <<< "$PROJECTS"

          echo "{\"total_todo\": $T_TODO, \"total_ongoing\": $T_ONGOING, \"total_closed\": $T_DONE}" > global-stats.json
          jq -n '[inputs]' project-*-stats.json > all-projects-summary.json

      - name: Inject Stats into README
        run: |
          # 1. Create the Markdown Table
          echo "| Project | Todo | Ongoing | Done |" > table.tmp
          echo "| :--- | :---: | :---: | :---: |" >> table.tmp
          jq -r '.[] | "| \(.project) | \(.todo) | \(.ongoing) | \(.done) |"' all-projects-summary.json >> table.tmp
          echo -e "\n_Last updated: $(date -u +'%Y-%m-%d %H:%M UTC')_" >> table.tmp
          
          # 2. Ensure tags exist in profile/README.md
          if ! grep -q "" profile/README.md; then
            echo -e "\n\n" >> profile/README.md
          fi
          
          # 3. Inject content between tags (hardcoded strings to prevent regex errors)
          sed -i '//,//{ //b; //b; d }' profile/README.md
          sed -i '//r table.tmp' profile/README.md

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "docs: weekly project metrics update" || exit 0
          git push
