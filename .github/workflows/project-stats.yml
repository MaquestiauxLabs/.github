name: Update Project Stats
on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  stats:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Fetch and Process Org Stats
        env:
          GH_TOKEN: ${{ secrets.METRICS_TOKEN }}
        run: |
          # 1. Get Projects (excluding .github)
          PROJECTS=$(gh api graphql -f query='query($org: String!){organization(login: $org){projectsV2(first: 20){nodes{id number title}}}}' -f org="MaquestiauxLabs" --jq '.data.organization.projectsV2.nodes[] | select(.title != ".github") | "\(.number)|\(.title)"')

          T_TODO=0; T_ONGOING=0; T_DONE=0

          while IFS="|" read -r NUM TITLE; do
            QUERY='query($org: String!, $num: Int!){organization(login: $org){projectV2(number: $num){items(first: 100){nodes{status:fieldValueByName(name:"Status"){... on ProjectV2ItemFieldSingleSelectValue{name}}}}}}}'
            RESULT=$(gh api graphql -f query="$QUERY" -f org="MaquestiauxLabs" -F num=$NUM)
            
            # Map your specific board labels
            P_TODO=$(echo $RESULT | jq '[.data.organization.projectV2.items.nodes[] | select(.status.name == "Todo" or .status.name == "Planned")] | length')
            P_ONGOING=$(echo $RESULT | jq '[.data.organization.projectV2.items.nodes[] | select(.status.name == "In Progress" or .status.name == "Ongoing")] | length')
            P_DONE=$(echo $RESULT | jq '[.data.organization.projectV2.items.nodes[] | select(.status.name == "Done" or .status.name == "Complete")] | length')

            T_TODO=$((T_TODO + P_TODO))
            T_ONGOING=$((T_ONGOING + P_ONGOING))
            T_DONE=$((T_DONE + P_DONE))

            echo "{\"project\": \"$TITLE\", \"todo\": $P_TODO, \"ongoing\": $P_ONGOING, \"done\": $P_DONE}" > "project-$NUM-stats.json"
          done <<< "$PROJECTS"

          echo "{\"total_todo\": $T_TODO, \"total_ongoing\": $T_ONGOING, \"total_closed\": $T_DONE}" > global-stats.json
          jq -n '[inputs]' project-*-stats.json > all-projects-summary.json

      - name: Inject Stats into README
        run: |
          FILE="profile/README.md"
          
          # 1. Ensure tags exist in the file to prevent sed error
          if ! grep -q "" "$FILE"; then
            echo -e "\n\n" >> "$FILE"
          fi

          # 2. Create the Table
          echo "| Project | Todo | Ongoing | Done |" > table.tmp
          echo "| :--- | :---: | :---: | :---: |" >> table.tmp
          jq -r '.[] | "| \(.project) | \(.todo) | \(.ongoing) | \(.done) |"' all-projects-summary.json >> table.tmp
          
          # 3. Use sed with literal tags (no empty slashes)
          sed -i '//,//{ //b; //b; d }' "$FILE"
          sed -i '//r table.tmp' "$FILE"

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "docs: update project metrics and README table" || exit 0
          git push
